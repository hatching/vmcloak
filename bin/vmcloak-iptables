#!/bin/bash

if [ $# -ne 0 ]; then
   if [[ $1 == '-h' ]]; then
       echo "Usage:"
       echo "    $0 ip_range/CIDR"
       echo "    $0 ip_range/CIDR interfaces"
       echo "    $0 192.168.56.0/24 eth0 wlan0"
       echo ""
       echo "By default will be:"
       echo "    $0 192.168.56.0/24 eth0 wlan0"
       echo ""
   fi
fi
    

# Credits to Mark Schloesser, Andriy Brukhovetskyy, https://github.com/rep/cuckoo-contrib
if [ "$#" -ne 0 ]; then
    VBOXNET=$1
else
   VBOXNET="192.168.56.0/24"
fi

if [ "$#" -ne 1 ]; then
    INTERFACES="${@:2}"
else
    INTERFACES="eth0 wlan0"
fi

iptables -F
iptables -t nat -F

for i in $INTERFACES; do
    iptables -t nat -A POSTROUTING -o $i -s $VBOXNET -j MASQUERADE
done

# Default drop.
iptables -P FORWARD DROP

# Existing connections.
iptables -A FORWARD -m state --state RELATED,ESTABLISHED -j ACCEPT

# Accept connections from vboxnet to the whole internet.
iptables -A FORWARD -s $VBOXNET -j ACCEPT

# Internal traffic.
iptables -A FORWARD -s $VBOXNET -d $VBOXNET -j ACCEPT

# Log stuff that reaches this point, could be noisy though.
iptables -A FORWARD -j LOG

# Actually enable forwarding of packets. This is Debian/Ubuntu specific.
echo 1 > /proc/sys/net/ipv4/ip_forward
